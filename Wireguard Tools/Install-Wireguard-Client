#!/usr/bin/env bash
set -e

if [[ $EUID -ne 0 ]]; then
  echo "Please run as root (sudo ./install-wireguard.sh)"
  exit 1
fi

echo "=== WireGuard Installer for Ubuntu ==="
apt-get update -y
apt-get install -y wireguard wireguard-tools
apt-get install -y resolvconf || true

read -rp "Public interface (default: eth0): " PUB_IF
PUB_IF=${PUB_IF:-eth0}

read -rp "WireGuard interface name (default: wg0): " WG_IF
WG_IF=${WG_IF:-wg0}

read -rp "Server private IP with CIDR (default: 10.0.0.1/24): " WG_ADDR
WG_ADDR=${WG_ADDR:-10.0.0.1/24}

read -rp "Listen port (default: 51820): " WG_PORT
WG_PORT=${WG_PORT:-51820}

read -rp "Allow client subnet (default: 10.0.0.0/24): " WG_CLIENT_SUBNET
WG_CLIENT_SUBNET=${WG_CLIENT_SUBNET:-10.0.0.0/24}

read -rp "Allowed IPs for peers (default: 0.0.0.0/0): " WG_ALLOWED_IPS
WG_ALLOWED_IPS=${WG_ALLOWED_IPS:-0.0.0.0/0}

echo
echo "=== Summary ==="
echo "Interface:       $WG_IF"
echo "Address:         $WG_ADDR"
echo "Listen port:     $WG_PORT"
echo "Public IF:       $PUB_IF"
echo "Client subnet:   $WG_CLIENT_SUBNET"
echo "Allowed IPs:     $WG_ALLOWED_IPS"
echo

read -rp "Continue and generate /etc/wireguard/${WG_IF}.conf? [y/N]: " CONFIRM
CONFIRM=${CONFIRM,,}
if [[ "$CONFIRM" != "y" ]]; then
  echo "Aborted."
  exit 0
fi

WG_DIR=/etc/wireguard
mkdir -p "$WG_DIR"
chmod 700 "$WG_DIR"

if [[ -f "$WG_DIR/server_private.key" ]]; then
  echo "[*] Existing keys found, reusing."
else
  echo "[*] Generating server keys..."
  umask 077
  wg genkey | tee "$WG_DIR/server_private.key" | wg pubkey > "$WG_DIR/server_public.key"
fi

SERVER_PRIV_KEY=$(cat "$WG_DIR/server_private.key")

WG_CONF="$WG_DIR/${WG_IF}.conf"

cat > "$WG_CONF" <<EOF
[Interface]
Address = ${WG_ADDR}
ListenPort = ${WG_PORT}
PrivateKey = ${SERVER_PRIV_KEY}

PostUp = iptables -A FORWARD -i ${WG_IF} -j ACCEPT; iptables -A FORWARD -o ${WG_IF} -j ACCEPT; iptables -t nat -A POSTROUTING -s ${WG_CLIENT_SUBNET} -o ${PUB_IF} -j MASQUERADE
PostDown = iptables -D FORWARD -i ${WG_IF} -j ACCEPT; iptables -D FORWARD -o ${WG_IF} -j ACCEPT; iptables -t nat -D POSTROUTING -s ${WG_CLIENT_SUBNET} -o ${PUB_IF} -j MASQUERADE
EOF

chmod 600 "$WG_CONF"

SYSCTL_FILE="/etc/sysctl.d/99-wireguard-forwarding.conf"
cat > "$SYSCTL_FILE" <<EOF
net.ipv4.ip_forward=1
EOF

sysctl --system > /dev/null

systemctl enable wg-quick@"${WG_IF}" >/dev/null 2>&1 || true
systemctl start wg-quick@"${WG_IF}" && wg show "${WG_IF}"

echo
echo "Done."
echo "Start/Stop: sudo wg-quick up ${WG_IF} | sudo wg-quick down ${WG_IF}"
echo "Config: ${WG_CONF}"