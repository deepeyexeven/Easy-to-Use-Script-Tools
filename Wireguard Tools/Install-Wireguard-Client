#!/bin/bash

set -e

if [ "$EUID" -ne 0 ]; then
  echo "Please run as root: sudo $0"
  exit 1
fi

WG_DIR="/etc/wireguard"
WG_CONF="$WG_DIR/wg0.conf"

apt update -y
apt upgrade -y
apt install -y wireguard resolvconf

modprobe wireguard || true

mkdir -p "$WG_DIR"
chmod 700 "$WG_DIR"

TMP_CONF="$(mktemp)"
trap 'rm -f "$TMP_CONF"' EXIT

echo
echo "============================================="
echo "Paste your WireGuard config below."
echo "When finished, press CTRL + D to save."
echo "============================================="
echo

tee "$TMP_CONF" >/dev/null

if [ ! -s "$TMP_CONF" ]; then
  echo "Error: configuration is empty."
  exit 1
fi

if ! grep -q "\[Interface\]" "$TMP_CONF"; then
  echo "Error: invalid config, missing [Interface] section."
  exit 1
fi

if ! grep -q "PrivateKey" "$TMP_CONF"; then
  echo "Error: invalid config, missing PrivateKey."
  exit 1
fi

mkdir -p "$WG_DIR"
chmod 700 "$WG_DIR"

mv "$TMP_CONF" "$WG_CONF"
chmod 600 "$WG_CONF"

echo
echo "Configuration saved to: $WG_CONF"
echo
echo "Review: sudo nano $WG_CONF"
echo
echo "Start: sudo systemctl start wg-quick@wg0"
echo "Enable on boot: sudo systemctl enable wg-quick@wg0"
echo "Status: sudo systemctl status wg-quick@wg0"
echo "        sudo wg show"
echo
echo "Done."
